<fragment>
	<send-one-way-request mode="copy" timeout="30">
		<set-url>{{CustomQuotaUpdateURL}}</set-url>
		<set-method>POST</set-method>
		<set-body>@{
                        
            var error = "";

            try
            {
                var responseBody = context.Response.Body?.As<JObject>(true);
                
                var completionToken = responseBody["usage"]["completion_tokens"] ?? 0;
                var promptToken = responseBody["usage"]["prompt_tokens"] ?? 0;
                var totalToken = responseBody["usage"]["total_tokens"] ?? 1;

                return new JObject(
                        new JProperty("subscriptionKey", context.Subscription?.Key),
                        new JProperty("model", responseBody["model"].ToString()),
                        new JProperty("prompTokens", promptToken.ToString()),
                        new JProperty("CompletionTokens", completionToken.ToString()),
                        new JProperty("TotalTokens", totalToken.ToString())
                        ).ToString();
            }
            catch (Exception ex)
            {
                error = ex.Message.ToString();
            }

            return new JObject(
                new JProperty("subscriptionKey", context.Subscription?.Key),
                new JProperty("model", error.ToString()),
                new JProperty("prompTokens", "0"),
                new JProperty("CompletionTokens", "0"),
                new JProperty("TotalTokens", "0")
                ).ToString();   

        }</set-body>
	</send-one-way-request>
</fragment>
